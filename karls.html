<!DOCTYPE htl>
<meta charset="utf-8">

<link href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçì</text></svg>"
      rel="icon">

<link href="https://unpkg.com/leaflet@latest/dist/leaflet.css" rel="stylesheet"/>
<style>
    html, body, #map {
        margin: 0;
        height: 100%;
        width: 100%;
    }
</style>
<meta content="initial-scale=1.0, user-scalable=no" name="viewport"/>
<title>Erdbeerfinder</title>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>
<script>
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLatLng = [position.coords.latitude, position.coords.longitude];
                map.setView(userLatLng, 14); // zoom level 14, adjust as needed
                L.marker(userLatLng).addTo(map).bindPopup("You are here!").openPopup();
            }, function () {
                alert("Unable to retrieve your location.");
            });
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    }

    var map = L.map('map');
    var layer;

    // Define the custom strawberry icon
    var strawberryIcon = L.icon({
        iconUrl: 'https://em-content.zobj.net/source/openmoji/413/strawberry_1f353.png',
        iconSize: [48, 48],      // increased size
        iconAnchor: [24, 48],    // center bottom
        popupAnchor: [0, -48]    // above the icon
    });

    // Use pointToLayer to set the icon for each feature
    function pointToLayer(feature, latlng) {
        return L.marker(latlng, {icon: strawberryIcon});
    }


    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    function onEachFeature(feature, layer) {
        if (feature.properties)
            layer.bindPopup(Object.entries(feature.properties).map((prop) => prop.join(': ')).join('<br>'));
    }


    function updateGeoJson() {
        if (layer) {
            map.removeLayer(layer);
            layer = undefined;
        }
        fetch("/karls.geo.json", {cors: true})
            .then((resp) => resp.json())
            .then((json) => {
                layer = L.geoJson(json, {onEachFeature, pointToLayer}).addTo(map);
                map.fitBounds(layer.getBounds());
            })
            .catch(() => alert('Error loading or parsing GeoJSON'))
    }

    updateGeoJson();
    locateUser();
</script>
