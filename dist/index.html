<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Erdbeerfinder</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">

    <!-- Favicon -->
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçì</text></svg>">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@latest/dist/L.Control.Locate.min.css">

    <!-- Custom Styles -->
    <style>
        html, body, #map {
            margin: 0;
            height: 100%;
            width: 100%;
        }

        :root {
            --map-tiles-filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        @media (prefers-color-scheme: dark) {
            .map-tiles {
                filter: var(--map-tiles-filter, none);
            }
        }

    </style>
</head>

<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol@latest/dist/L.Control.Locate.min.js"></script>

<script>

    const map = L.map('map', {
        zoomSnap: 0.25,
    });

    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        className: 'map-tiles'
    }).addTo(map);


    const locateControl = L.control.locate({
        locateOptions: {
            maxZoom: 15.5,
        }
    }).addTo(map);
    locateControl.start();

    let geoJsonLayer;

    // Define icons
    const strawberryIcon = L.icon({
        iconUrl: 'strawberry.png',
        iconSize: [48, 48],
        iconAnchor: [24, 48],
        popupAnchor: [0, -48]
    });

    const strawberryIconBW = L.icon({
        iconUrl: 'strawberry_bw.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    function pointToLayer(feature, latlng) {
        const icon = feature.properties?.isOpened ? strawberryIcon : strawberryIconBW;
        return L.marker(latlng, {icon});
    }

    function onEachFeature(feature, layer) {
        if (feature.properties) {
            const name = feature.properties.name || 'Unknown Name';
            let popupContent = `<b>${name}</b><br>`;
            popupContent += `<br>Last Seen: ${new Date(feature.properties.lastSeen).toLocaleString('de-DE', {
                dateStyle: 'medium',
                timeStyle: 'short'
            }) || '??'}`;
            popupContent += `<br>locationGroup: ${feature.properties.locationGroup || 'ü§∑'}`;
            layer.bindPopup(popupContent);
        }

    }


    function updateGeoJson() {
        if (geoJsonLayer) {
            map.removeLayer(geoJsonLayer);
        }
        fetch("/karls.geo.json")
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.json();
            })
            .then(data => {
                geoJsonLayer = L.geoJson(data, {onEachFeature, pointToLayer}).addTo(map);
                map.fitBounds(geoJsonLayer.getBounds());
            })
            .catch(err => {
                console.error(err);
                alert('Error loading or parsing GeoJSON');
            });
    }

    updateGeoJson();
    setInterval(updateGeoJson, 2 * 60 * 1000);
</script>
</body>
</html>
